---
layout: post
title: Vagrant Box Howto
---
<h2>Vagrant Box Howto</h2>
Vagrant ist ein hervoragendes Tool für Entwickler aber auch generell für IT Test- Entwicklungssysteme. Es gibt einige Möglichkeiten vorkonfigurierte Vagrant Box aus dem Internet zu laden. Da ich aber lieber Kontrolle über die Maschinen habe die ich einsetzte habe ich nach einer brauchbaren Dokumentation gesucht wie man sich eine eigene Vagrant Box baut.

1. Downloade und installiere <a href="httpss://www.virtualbox.org/wiki/Downloads">VirtualBox</a>

<a href="https://www.elastic2ls.com/wp-content/uploads/2018/02/virtualbox.jpg"><img class="wp-image-2208 size-thumbnail alignnone" src="https://www.elastic2ls.com/wp-content/uploads/2018/02/virtualbox-150x150.jpg" alt="vagrant box" width="150" height="150" /></a>

2. Downloade ein <a href="https://wiki.centos.org/Download">CentOS iso image</a>

<a href="https://www.elastic2ls.com/wp-content/uploads/2018/02/centos.png"><img class="alignnone size-medium wp-image-2209" src="https://www.elastic2ls.com/wp-content/uploads/2018/02/centos-300x158.png" alt="vagrant box" width="300" height="158" /></a>

3. Baue eine neue VM in VirtualBox:
<p style="text-align: left; padding-left: 30px;">Name = "vagrant-centos7
Linuxversion = Red Hat
Extra = deaktivieren von audio und usb</p>
&nbsp;

4. Boote die VM und installiere CentOS 7:
<p style="padding-left: 30px;">Setze das Root Passwort "vagrant":
Als "normalen" Benutzer legst die "vagrant" mit dem Password "vagrant" an
Der Hostname ist "vagrant-centos7"</p>
&nbsp;

5. Nach erfolgreicher Installation solltest du dich in die VM einloggen und als erstes den Openssh-Server installieren.
<p style="padding-left: 30px;"><code>root@vagrant-centos7$ yum install openssh-server
root@vagrant-centos7$ service sshd start
root@vagrant-centos7$ chkconfig sshd on
root@vagrant-centos7$ netstat -tulpn | grep :22</code>

&nbsp;

6. Anschliessend erlauben wir der VM das Portforwarding für SSH. Dafür gibt es zwei Wege:

<p style="padding-left: 30px;">a. Stoppe die VM und von der CMD Line oder Terminal führst du folgenden Befehl aus:</p>
<p style="padding-left: 30px;"><code>you@host$ VBoxManage modifyvm "vagrant-centos7" --natpf1 "guestssh,tcp,,2222,,22"</code></p>
<p style="padding-left: 30px;">b. Stoppe die VM und setze das Portforwarding in der Gui von VirtualBox.</p>
<p style="padding-left: 30px;"><a href="https://www.elastic2ls.com/wp-content/uploads/2018/02/VBOx-Portforwaring-550x293.png"><img class="alignnone size-medium wp-image-2210" src="https://www.elastic2ls.com/wp-content/uploads/2018/02/VBOx-Portforwaring-550x293-300x160.png" alt="vagrant box" width="300" height="160" /></a></p>
&nbsp;

7. Jetzt können wir uns testweise per SSH einlogen:
<p style="padding-left: 30px;"><code>you@host$ ssh -p 2222 root@127.0.0.1</code></p>
&nbsp;

8. Installieren von Basis Paketen für die VM
<p style="padding-left: 30px;"><code>root@vagrant-centos7$ yum install nano wget gcc bzip2 make kernel-devel-`uname -r`</code></p>
&nbsp;

9. Instalierne der VirtualBox Gäste Tools (Gui oder in der VM gemountet?)

&nbsp;

10. Füge den Benutzer Vagrant der Gruppe Admin hinzu:
<p style="padding-left: 30px;"><code>root@vagrant-centos7$ groupadd admin
root@vagrant-centos7$ usermod -G admin vagrant</code>

&nbsp;

11. Passe die sudoers Datei an:

<p style="padding-left: 30px;"><code>Add SSH_AUTH_SOCK to the env_keep option
Comment out the Defaults requiretty line
Add the line %admin ALL=NOPASSWD: ALL</code>

<p style="padding-left: 30px;">Der Benutzer Vagrant sollte jetzt in der Lage sein das sudo Kommando ohne Passwort Abfrage zu verwenden</p>
<p style="padding-left: 30px;"><code>vagrant@vagrant-centos62$ sudo ls</code></p>
&nbsp;

12.Füge den Public key von vagrant hinzu, damit sihc der User vagrant ohne Passwort per SSH verbinden kann. Wird für das Kommando &lt;code&gt;vagrant ssh&lt;/code&gt; gebraucht.
<p style="padding-left: 30px;"><code>vagrant@vagrant-centos7$ mkdir .ssh
vagrant@vagrant-centos7$ curl -k httpss://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub &gt; .ssh/authorized_keys
vagrant@vagrant-centos7$ chmod 0700 .ssh
vagrant@vagrant-centos7$ chmod 0600 .ssh/authorized_keys</code>

&nbsp;

13. Das Netzwerkinterface anpassen

<p style="padding-left: 30px;">vagrant@vagrant-centos62$ vi /etc/sysconfig/network-scripts/ifcfg-eth0</p>
<p style="padding-left: 30px;">Change:</p>
<p style="padding-left: 30px;"><code>ONBOOT=no</code></p>
<p style="padding-left: 30px;">To parameters and values:</p>
<p style="padding-left: 30px;"><code>ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=dhcp</code>

&nbsp;

14. zum Abschluss räumern wir in der VM noch etwas auf und packen die Vagrant Base-Box.

<p style="padding-left: 30px;"><code>vagrant@vagrant-centos62$ sudo yum clean all &amp;&amp; sudo halt</code></p>
<p style="padding-left: 30px;"><code>you@host$ vagrant package --output centos7.box --base centos7_default_1434544491721_62573
you@host$ vagrant box add centos7 centos7.box</code>

<p style="padding-left: 30px;">Der Name der hinter <b>--base</b>; sollte identisch sein mit dem Namen der VM in Virtual Box.</p>
<p style="padding-left: 30px;"><img class="alignnone size-full wp-image-529" src="https://www.elastic2ls.com/wp-content/uploads/2015/06/centos_base_box_export.jpg" alt="centos_base_box_export" width="357" height="52" /></p>
<p style="padding-left: 30px;">Du solltest jetzt die neu erstellte Vagrant Base-Box in der Liste der Boxen in vagrant finden.</p>
<p style="padding-left: 30px;">you@host$ vagrant box list
centos7.box</p>
<p style="padding-left: 30px;">Ab hier kannst du in jedem Ordner ganz einfach eine neue VM kreieren.</p>
<p style="padding-left: 30px;"><code>you@host$ /home/user/my_vm $ vagrant init centos7
you@host$ /home/user/my_vm $ vagrant up
you@host$ /home/user/my_vm $ vagrant ssh</code>

<p style="padding-left: 30px;">Um die VM auf einer neuen Maschine nutzen zu können kopiere dir die Datei centos7.box dorthin und führe folgende Schritte aus.</p>
<p style="padding-left: 30px;"><code>you@otherhost$ /home/user/my_vm $ vagrant box add centos7 centos7.box</code></p>
<p style="padding-left: 30px;"><code>you@otherhost$ /home/user/my_vm $ vagrant init centos7</code></p>
<p style="padding-left: 30px;"><code>you@otherhost$ /home/user/my_vm $ vagrant up</code></p>
<p style="padding-left: 30px;"><code>you@otherhost$ /home/user/my_vm $ vagrant ssh</code></p>
E Voilà. Das wars. Jetzt hast du eie Base Box die du als Grundlage für deine Tests benutzen kannst.

&nbsp;

&nbsp;

15. VirtualBox Guest Addittions

Leider hatte ich vergessen die Gast Erweiterungen in die Box zu installieren. Das müssen wir noch nachholen. Als erstes solltest du das <a href="httpss://virtualbox.org/wiki/Downloads">passende Paket herunterladen</a>. Binde das Iso file unter "Geräte =&gt; Optische Laufwerke =&gt; Abild auswählen" aus. Dann moute es folgendermassen.

<code>mount -r /dev/cdrom /media</code>

Binde das EPEL Repository ein
<code>rpm -Uvh https://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm</code>

und installiere die folgende Pakete
<code>yum install gcc kernel-devel kernel-headers dkms make bzip2 perl</code>

und erstelle die KERN_DIR environment variable
<code>KERN_DIR=/usr/src/kernels/`uname -r`
export KERN_DIR</code>

Jetzt kannst du die Gäste Erweiterung installieren und danach rebooten
<code>./VBoxLinuxAdditions.run &amp;&amp; reboot</code>

Danach solltest due die Box erneut exportieren wie oben genannt.

Quelle:

<a href="httpss://github.com/ckan/ckan/wiki/How-to-Create-a-CentOS-Vagrant-Base-Box">httpss://github.com/ckan/ckan/wiki/How-to-Create-a-CentOS-Vagrant-Base-Box</a>
<a href="https://docs.vagrantup.com/v2/getting-started/">https://docs.vagrantup.com/v2/getting-started/</a>
